{% extends 'base.html' %}
{% load static %}

{% block title %}Inscripciones - PRCE{% endblock %}

{% block page_title %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
    <div>
        <h1>Gesti칩n de Inscripciones</h1>
        <p style="color: #6c757d; margin: 0.5rem 0 0;">
            {% if user.puede_gestionar_eventos %}
                Administre todas las inscripciones del sistema
            {% else %}
                Mis inscripciones
            {% endif %}
        </p>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Filtros y B칰squeda -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
        <h3>Filtros y B칰squeda</h3>
    </div>
    <div class="card-body">
        <form method="get" action="{% url 'inscripciones:lista' %}" style="display: grid; gap: 1rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <!-- B칰squeda -->
                <div class="form-group">
                    <label for="id_q" class="form-label">Buscar</label>
                    <input 
                        type="text" 
                        name="q" 
                        id="id_q" 
                        class="form-control" 
                        placeholder="Nombre, correo, documento o evento..."
                        value="{{ filtros_activos.q }}"
                    >
                </div>
                
                <!-- Evento (solo para administradores/organizadores) -->
                {% if eventos_para_filtro %}
                <div class="form-group">
                    <label for="id_evento" class="form-label">Evento</label>
                    <select name="evento" id="id_evento" class="form-control">
                        <option value="">Todos los eventos</option>
                        {% for evento in eventos_para_filtro %}
                            <option value="{{ evento.pk }}" {% if filtros_activos.evento == evento.pk|stringformat:"d" %}selected{% endif %}>
                                {{ evento.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                
                <!-- Estado -->
                <div class="form-group">
                    <label for="id_estado" class="form-label">Estado</label>
                    <select name="estado" id="id_estado" class="form-control">
                        <option value="">Todos los estados</option>
                        <option value="PENDIENTE" {% if filtros_activos.estado == 'PENDIENTE' %}selected{% endif %}>Pendiente</option>
                        <option value="CONFIRMADA" {% if filtros_activos.estado == 'CONFIRMADA' %}selected{% endif %}>Confirmada</option>
                        <option value="CANCELADA" {% if filtros_activos.estado == 'CANCELADA' %}selected{% endif %}>Cancelada</option>
                        <option value="RECHAZADA" {% if filtros_activos.estado == 'RECHAZADA' %}selected{% endif %}>Rechazada</option>
                    </select>
                </div>
            </div>
            
            <!-- Fechas -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="id_fecha_desde" class="form-label">Fecha Desde</label>
                    <input 
                        type="date" 
                        name="fecha_desde" 
                        id="id_fecha_desde" 
                        class="form-control"
                        value="{{ filtros_activos.fecha_desde }}"
                    >
                </div>
                
                <div class="form-group">
                    <label for="id_fecha_hasta" class="form-label">Fecha Hasta</label>
                    <input 
                        type="date" 
                        name="fecha_hasta" 
                        id="id_fecha_hasta" 
                        class="form-control"
                        value="{{ filtros_activos.fecha_hasta }}"
                    >
                </div>
            </div>
            
            <!-- Botones -->
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary">
                    游댌 Buscar
                </button>
                <a href="{% url 'inscripciones:lista' %}" class="btn btn-secondary">
                    游댃 Limpiar Filtros
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Resultados -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">Inscripciones ({{ total_inscripciones }})</h3>
    </div>
    <div class="card-body">
        {% if inscripciones %}
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Evento</th>
                        <th>Participante</th>
                        <th>Correo</th>
                        <th>Documento</th>
                        <th>Fecha de Inscripci칩n</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inscripcion in inscripciones %}
                    <tr>
                        <td>
                            <a href="{% url 'eventos:detalle' inscripcion.evento.pk %}">
                                {{ inscripcion.evento.nombre }}
                            </a>
                            <br>
                            <small style="color: #6c757d;">
                                {{ inscripcion.evento.fecha_inicio|date:"d/m/Y H:i" }}
                            </small>
                        </td>
                        <td>
                            <strong>{{ inscripcion.get_nombre_completo }}</strong>
                            {% if inscripcion.usuario %}
                                <br><small style="color: #6c757d;">Usuario registrado</small>
                            {% endif %}
                        </td>
                        <td>{{ inscripcion.correo }}</td>
                        <td>{{ inscripcion.documento }}</td>
                        <td>{{ inscripcion.fecha_inscripcion|date:"d/m/Y H:i" }}</td>
                        <td>
                            {% if inscripcion.estado == 'PENDIENTE' %}
                                <span class="badge badge-warning">{{ inscripcion.get_estado_display }}</span>
                            {% elif inscripcion.estado == 'CONFIRMADA' %}
                                <span class="badge badge-success">{{ inscripcion.get_estado_display }}</span>
                            {% elif inscripcion.estado == 'CANCELADA' %}
                                <span class="badge badge-danger">{{ inscripcion.get_estado_display }}</span>
                            {% elif inscripcion.estado == 'RECHAZADA' %}
                                <span class="badge" style="background-color: #95a5a6; color: white;">{{ inscripcion.get_estado_display }}</span>
                            {% else %}
                                <span class="badge badge-secondary">{{ inscripcion.get_estado_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <a href="{% url 'inscripciones:detalle' inscripcion.pk %}" class="btn btn-sm btn-secondary">
                                    Ver
                                </a>
                                {% if user.puede_gestionar_eventos %}
                                    {% if inscripcion.estado != 'CONFIRMADA' %}
                                        <a href="{% url 'inscripciones:confirmar' inscripcion.pk %}" class="btn btn-sm btn-success" onclick="return confirm('쮺onfirmar esta inscripci칩n?');">
                                            Confirmar
                                        </a>
                                    {% endif %}
                                    {% if inscripcion.estado != 'CANCELADA' %}
                                        <a href="{% url 'inscripciones:cancelar' inscripcion.pk %}" class="btn btn-sm btn-danger" onclick="return confirm('쮺ancelar esta inscripci칩n?');">
                                            Cancelar
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <strong>No hay inscripciones registradas.</strong>
            {% if not user.puede_gestionar_eventos %}
                <p style="margin-top: 0.5rem;">
                    <a href="{% url 'inscripciones:registro_publico' %}">Explorar eventos disponibles</a>
                </p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

