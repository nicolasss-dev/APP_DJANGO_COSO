{% extends 'base.html' %}
{% load static %}

{% block title %}Eventos - PRCE{% endblock %}

{% block page_title %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
    <div>
        <h1>Gestión de Eventos</h1>
        <p style="color: #6c757d; margin: 0.5rem 0 0;">
            {% if user.puede_gestionar_eventos %}
                Administre todos los eventos del sistema
            {% else %}
                Explore los eventos disponibles
            {% endif %}
        </p>
    </div>
    {% if user.puede_gestionar_eventos %}
    <a href="{% url 'eventos:crear' %}" class="btn btn-primary">
        + Crear Nuevo Evento
    </a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<!-- Filtros y Búsqueda -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
        <h3>Filtros y Búsqueda</h3>
    </div>
    <div class="card-body">
        <form method="get" action="{% url 'eventos:lista' %}" style="display: grid; gap: 1rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <!-- Búsqueda -->
                <div class="form-group">
                    <label for="id_q" class="form-label">Buscar</label>
                    <input 
                        type="text" 
                        name="q" 
                        id="id_q" 
                        class="form-control" 
                        placeholder="Nombre, descripción o lugar..."
                        value="{{ filtros_activos.q }}"
                    >
                </div>
                
                <!-- Tipo de Evento -->
                <div class="form-group">
                    <label for="id_tipo" class="form-label">Tipo de Evento</label>
                    <select name="tipo" id="id_tipo" class="form-control">
                        <option value="">Todos los tipos</option>
                        {% for tipo in tipos_evento %}
                            <option value="{{ tipo.nombre }}" {% if filtros_activos.tipo == tipo.nombre %}selected{% endif %}>
                                {{ tipo.get_nombre_display }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Estado -->
                {% if user.puede_gestionar_eventos %}
                <div class="form-group">
                    <label for="id_estado" class="form-label">Estado</label>
                    <select name="estado" id="id_estado" class="form-control">
                        <option value="">Todos los estados</option>
                        <option value="BORRADOR" {% if filtros_activos.estado == 'BORRADOR' %}selected{% endif %}>Borrador</option>
                        <option value="PUBLICADO" {% if filtros_activos.estado == 'PUBLICADO' %}selected{% endif %}>Publicado</option>
                        <option value="EN_CURSO" {% if filtros_activos.estado == 'EN_CURSO' %}selected{% endif %}>En Curso</option>
                        <option value="FINALIZADO" {% if filtros_activos.estado == 'FINALIZADO' %}selected{% endif %}>Finalizado</option>
                        <option value="CANCELADO" {% if filtros_activos.estado == 'CANCELADO' %}selected{% endif %}>Cancelado</option>
                    </select>
                </div>
                {% endif %}
                
                <!-- Orden -->
                <div class="form-group">
                    <label for="id_orden" class="form-label">Ordenar por</label>
                    <select name="orden" id="id_orden" class="form-control">
                        <option value="-fecha_inicio" {% if filtros_activos.orden == '-fecha_inicio' %}selected{% endif %}>Fecha (más próximo)</option>
                        <option value="fecha_inicio" {% if filtros_activos.orden == 'fecha_inicio' %}selected{% endif %}>Fecha (más lejano)</option>
                        <option value="nombre" {% if filtros_activos.orden == 'nombre' %}selected{% endif %}>Nombre (A-Z)</option>
                        <option value="-nombre" {% if filtros_activos.orden == '-nombre' %}selected{% endif %}>Nombre (Z-A)</option>
                        <option value="-fecha_creacion" {% if filtros_activos.orden == '-fecha_creacion' %}selected{% endif %}>Más recientes</option>
                    </select>
                </div>
            </div>
            
            <!-- Fechas -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="id_fecha_desde" class="form-label">Fecha Desde</label>
                    <input 
                        type="date" 
                        name="fecha_desde" 
                        id="id_fecha_desde" 
                        class="form-control"
                        value="{{ filtros_activos.fecha_desde }}"
                    >
                </div>
                
                <div class="form-group">
                    <label for="id_fecha_hasta" class="form-label">Fecha Hasta</label>
                    <input 
                        type="date" 
                        name="fecha_hasta" 
                        id="id_fecha_hasta" 
                        class="form-control"
                        value="{{ filtros_activos.fecha_hasta }}"
                    >
                </div>
            </div>
            
            <!-- Botones -->
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary">
                     Buscar
                </button>
                <a href="{% url 'eventos:lista' %}" class="btn btn-secondary">
                     Limpiar Filtros
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Resultados -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">Eventos ({{ eventos.count }})</h3>
        {% if user.puede_gestionar_eventos %}
        <a href="{% url 'eventos:crear' %}" class="btn btn-primary">
            + Crear Nuevo Evento
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if eventos %}
        <div style="display: grid; gap: 1.5rem;">
            {% for evento in eventos %}
            <div class="card" style="margin-bottom: 0;">
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 1.5rem; align-items: start;">
                        <!-- Imagen del evento -->
                        <div style="width: 200px; height: 120px; overflow: hidden; background-color: #e0e0e0; display: flex; align-items: center; justify-content: center;">
                            {% if evento.imagen_banner %}
                                <img src="{{ evento.imagen_banner.url }}" alt="{{ evento.nombre }}" style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                                <span style="color: #6c757d; font-size: 3rem;"></span>
                            {% endif %}
                        </div>
                        
                        <!-- Información del evento -->
                        <div>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                <span class="badge badge-info">{{ evento.tipo_evento }}</span>
                                
                                {% if evento.estado == 'BORRADOR' %}
                                    <span class="badge badge-secondary">{{ evento.get_estado_display }}</span>
                                {% elif evento.estado == 'PUBLICADO' %}
                                    <span class="badge badge-success">{{ evento.get_estado_display }}</span>
                                {% elif evento.estado == 'EN_CURSO' %}
                                    <span class="badge badge-warning">{{ evento.get_estado_display }}</span>
                                {% elif evento.estado == 'FINALIZADO' %}
                                    <span class="badge" style="background-color: #95a5a6; color: white;">{{ evento.get_estado_display }}</span>
                                {% elif evento.estado == 'CANCELADO' %}
                                    <span class="badge badge-danger">{{ evento.get_estado_display }}</span>
                                {% endif %}
                                
                                {% if evento.esta_lleno %}
                                    <span class="badge badge-danger">LLENO</span>
                                {% endif %}
                                
                                {% if evento.es_gratuito %}
                                    <span class="badge badge-success">GRATUITO</span>
                                {% endif %}
                            </div>
                            
                            <h3 style="margin: 0.5rem 0;">
                                <a href="{% url 'eventos:detalle' evento.pk %}">{{ evento.nombre }}</a>
                            </h3>
                            
                            <p style="color: #6c757d; margin: 0.5rem 0;">
                                {{ evento.descripcion|truncatewords:30 }}
                            </p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin-top: 1rem; font-size: 0.875rem;">
                                <div>
                                    <strong> Inicio:</strong><br>
                                    {{ evento.fecha_inicio|date:"d/m/Y H:i" }}
                                </div>
                                <div>
                                    <strong> Lugar:</strong><br>
                                    {{ evento.lugar }}
                                </div>
                                <div>
                                    <strong> Cupos:</strong><br>
                                    {{ evento.total_inscritos }}/{{ evento.cupo_maximo }}
                                </div>
                                {% if not evento.es_gratuito %}
                                <div>
                                    <strong> Costo:</strong><br>
                                    ${{ evento.costo|floatformat:2 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Acciones -->
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; min-width: 150px;">
                            <a href="{% url 'eventos:detalle' evento.pk %}" class="btn btn-secondary">
                                Ver Detalle
                            </a>
                            
                            {% if user.puede_gestionar_eventos %}
                                <a href="{% url 'eventos:editar' evento.pk %}" class="btn btn-secondary">
                                    Editar
                                </a>
                                
                                {% if evento.estado == 'BORRADOR' %}
                                    <form method="post" action="{% url 'eventos:publicar' evento.pk %}" style="margin: 0;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                                            Publicar
                                        </button>
                                    </form>
                                {% endif %}
                                
                                <a href="{% url 'eventos:duplicar' evento.pk %}" class="btn btn-secondary">
                                    Duplicar
                                </a>
                                
                                {% if user.es_administrador %}
                                    <a href="{% url 'eventos:eliminar' evento.pk %}" class="btn btn-danger">
                                        Eliminar
                                    </a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info">
            No hay eventos disponibles en este momento.
            {% if user.puede_gestionar_eventos %}
                <a href="{% url 'eventos:crear' %}">¿Desea crear uno?</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

