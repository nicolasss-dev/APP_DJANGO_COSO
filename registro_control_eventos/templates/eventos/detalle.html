{% extends 'base.html' %}
{% load static %}

{% block title %}{{ evento.nombre }} - PRCE{% endblock %}

{% block page_title %}
<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
    <div>
        <h1>{{ evento.nombre }}</h1>
        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
            <span class="badge badge-info">{{ evento.tipo_evento }}</span>
            
            {% if evento.estado == 'BORRADOR' %}
                <span class="badge badge-secondary">{{ evento.get_estado_display }}</span>
            {% elif evento.estado == 'PUBLICADO' %}
                <span class="badge badge-success">{{ evento.get_estado_display }}</span>
            {% elif evento.estado == 'EN_CURSO' %}
                <span class="badge badge-warning">{{ evento.get_estado_display }}</span>
            {% elif evento.estado == 'FINALIZADO' %}
                <span class="badge" style="background-color: #95a5a6; color: white;">{{ evento.get_estado_display }}</span>
            {% elif evento.estado == 'CANCELADO' %}
                <span class="badge badge-danger">{{ evento.get_estado_display }}</span>
            {% endif %}
        </div>
    </div>
    
    {% if user.puede_gestionar_eventos %}
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <a href="{% url 'eventos:editar' evento.pk %}" class="btn btn-secondary">
            Editar
        </a>
        <a href="{% url 'eventos:duplicar' evento.pk %}" class="btn btn-secondary">
            Duplicar
        </a>
        {% if evento.estado == 'BORRADOR' %}
            <form method="post" action="{% url 'eventos:publicar' evento.pk %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">
                    Publicar Evento
                </button>
            </form>
        {% endif %}
        <a href="{% url 'eventos:lista' %}" class="btn btn-secondary">
            Volver a Lista
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<!-- Banner del evento -->
{% if evento.imagen_banner %}
<div style="width: 100%; height: 400px; overflow: hidden; margin-bottom: 2rem;">
    <img src="{{ evento.imagen_banner.url }}" alt="{{ evento.nombre }}" 
         style="width: 100%; height: 100%; object-fit: cover;">
</div>
{% endif %}

<!-- Información Principal -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
    <!-- Columna Izquierda -->
    <div>
        <div class="card">
            <div class="card-header">
                <h2>Descripción del Evento</h2>
            </div>
            <div class="card-body">
                <p style="white-space: pre-line;">{{ evento.descripcion }}</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2>Detalles</h2>
            </div>
            <div class="card-body">
                <table class="table">
                    <tr>
                        <th style="width: 30%;">Fecha y Hora de Inicio:</th>
                        <td>{{ evento.fecha_inicio|date:"l, d \d\e F \d\e Y \a \l\a\s H:i" }}</td>
                    </tr>
                    <tr>
                        <th>Fecha y Hora de Fin:</th>
                        <td>{{ evento.fecha_fin|date:"l, d \d\e F \d\e Y \a \l\a\s H:i" }}</td>
                    </tr>
                    <tr>
                        <th>Lugar:</th>
                        <td>{{ evento.lugar }}</td>
                    </tr>
                    {% if evento.direccion %}
                    <tr>
                        <th>Dirección:</th>
                        <td>{{ evento.direccion }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Tipo de Evento:</th>
                        <td><span class="badge badge-info">{{ evento.tipo_evento }}</span></td>
                    </tr>
                    <tr>
                        <th>Número de Sesiones:</th>
                        <td>{{ evento.numero_sesiones }}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        {% if user.puede_gestionar_eventos %}
        <div class="card">
            <div class="card-header">
                <h2>Inscripciones</h2>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div style="padding: 1rem; background-color: #f5f5f5; text-align: center;">
                        <strong style="font-size: 2rem; color: #3498db;">{{ evento.total_inscritos }}</strong><br>
                        <span style="color: #6c757d;">Inscritos</span>
                    </div>
                    <div style="padding: 1rem; background-color: #f5f5f5; text-align: center;">
                        <strong style="font-size: 2rem; color: #27ae60;">{{ evento.cupos_disponibles }}</strong><br>
                        <span style="color: #6c757d;">Cupos Disponibles</span>
                    </div>
                    <div style="padding: 1rem; background-color: #f5f5f5; text-align: center;">
                        <strong style="font-size: 2rem; color: #f39c12;">{{ evento.cupo_maximo }}</strong><br>
                        <span style="color: #6c757d;">Cupo Máximo</span>
                    </div>
                    <div style="padding: 1rem; background-color: #f5f5f5; text-align: center;">
                        <strong style="font-size: 2rem; color: #e74c3c;">{{ evento.porcentaje_ocupacion|floatformat:0 }}%</strong><br>
                        <span style="color: #6c757d;">Ocupación</span>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; text-align: center;">
                    <a href="{% url 'inscripciones:lista' %}?evento={{ evento.pk }}" class="btn btn-secondary">
                        Ver Inscritos
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Columna Derecha -->
    <div>
        <div class="card">
            <div class="card-header">
                <h3>Información de Inscripción</h3>
            </div>
            <div class="card-body">
                <div style="text-align: center; padding: 1rem;">
                    {% if evento.es_gratuito %}
                        <div style="font-size: 2rem; color: #27ae60; font-weight: bold; margin-bottom: 1rem;">
                            GRATUITO
                        </div>
                    {% else %}
                        <div style="font-size: 1rem; color: #6c757d; margin-bottom: 0.5rem;">
                            Costo de Inscripción:
                        </div>
                        <div style="font-size: 2rem; color: #2c3e50; font-weight: bold; margin-bottom: 1rem;">
                            ${{ evento.costo|floatformat:2 }}
                        </div>
                    {% endif %}
                </div>
                
                <div style="padding: 1rem; background-color: #f5f5f5; margin-bottom: 1rem;">
                    <div style="margin-bottom: 0.5rem;">
                        <strong>Cupos Disponibles:</strong> {{ evento.cupos_disponibles }} de {{ evento.cupo_maximo }}
                    </div>
                    
                    {% if evento.genera_certificado %}
                    <div style="margin-bottom: 0.5rem;">
                        <strong>✓</strong> Genera certificado
                    </div>
                    <div style="font-size: 0.875rem; color: #6c757d;">
                        Asistencia mínima requerida: {{ evento.porcentaje_asistencia_minimo }}%
                    </div>
                    {% endif %}
                </div>
                
                {% if evento.puede_inscribirse and not user.puede_gestionar_eventos %}
                    <a href="{% url 'inscripciones:registro_publico_evento' evento.pk %}" class="btn btn-primary" style="width: 100%;">
                        Inscribirse Ahora
                    </a>
                {% elif user.puede_gestionar_eventos %}
                    <div style="padding: 1rem; background-color: #d1ecf1; border-left: 4px solid #0c5460; color: #0c5460;">
                        <small>
                            <strong>Nota:</strong> Como organizador, puede gestionar las inscripciones desde el panel de control.
                        </small>
                    </div>
                {% else %}
                    {% if evento.esta_lleno %}
                        <button class="btn btn-danger" style="width: 100%;" disabled>
                            Evento sin cupos disponibles
                        </button>
                    {% elif evento.estado == 'FINALIZADO' %}
                        <button class="btn btn-secondary" style="width: 100%;" disabled>
                            Evento Finalizado
                        </button>
                    {% elif evento.estado == 'CANCELADO' %}
                        <button class="btn btn-danger" style="width: 100%;" disabled>
                            Evento Cancelado
                        </button>
                    {% else %}
                        <button class="btn btn-secondary" style="width: 100%;" disabled>
                            Inscripciones no disponibles
                        </button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        
        {% if inscripcion_usuario and inscripcion_usuario.estado == 'CONFIRMADA' %}
        <div class="card">
            <div class="card-header">
                <h3>Mi Certificado</h3>
            </div>
            <div class="card-body">
                <div style="margin-bottom: 1rem;">
                    <strong>Progreso de Asistencia:</strong>
                    <div class="progress mt-2" style="height: 25px;">
                        <div class="progress-bar {% if inscripcion_usuario.porcentaje_asistencia >= evento.porcentaje_asistencia_minimo %}bg-success{% else %}bg-warning{% endif %}" 
                             role="progressbar" 
                             style="width: {{ inscripcion_usuario.porcentaje_asistencia }}%">
                            {{ inscripcion_usuario.porcentaje_asistencia|floatformat:0 }}%
                        </div>
                    </div>
                    <small class="text-muted mt-1 d-block">Mínimo requerido: {{ evento.porcentaje_asistencia_minimo }}%</small>
                </div>
                
                {% if certificado_usuario %}
                    <div class="alert alert-success" style="margin-bottom: 0;">
                        <h5><i class="fas fa-check-circle"></i> Certificado Disponible</h5>
                        <p class="mb-2">Tu certificado ha sido generado exitosamente.</p>
                        <a href="{% url 'certificados:descargar' certificado_usuario.pk %}" class="btn btn-success btn-sm">
                            <i class="fas fa-eye"></i> Ver mi Certificado
                        </a>
                    </div>
                {% elif inscripcion_usuario.puede_generar_certificado %}
                    <div class="alert alert-info" style="margin-bottom: 0;">
                        <h5><i class="fas fa-award"></i> ¡Elegible para Certificado!</h5>
                        <p class="mb-2">Has completado los requisitos de asistencia.</p>
                        <a href="{% url 'certificados:generar' inscripcion_usuario.pk %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-certificate"></i> Generar Certificado
                        </a>
                    </div>
                {% else %}
                    <div class="alert alert-warning" style="margin-bottom: 0;">
                        <h5><i class="fas fa-hourglass-half"></i> En Progreso</h5>
                        <p class="mb-0">Continúa asistiendo para alcanzar el {{ evento.porcentaje_asistencia_minimo }}% requerido.</p>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <div class="card">
            <div class="card-header">
                <h3>Información de Auditoría</h3>
            </div>
            <div class="card-body">
                <table style="width: 100%; font-size: 0.875rem;">
                    <tr>
                        <td style="padding: 0.5rem 0;"><strong>Creado por:</strong></td>
                        <td style="padding: 0.5rem 0;">{{ evento.creado_por.get_full_name|default:evento.creado_por.username }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.5rem 0;"><strong>Fecha de creación:</strong></td>
                        <td style="padding: 0.5rem 0;">{{ evento.fecha_creacion|date:"d/m/Y H:i" }}</td>
                    </tr>
                    {% if evento.modificado_por %}
                    <tr>
                        <td style="padding: 0.5rem 0;"><strong>Modificado por:</strong></td>
                        <td style="padding: 0.5rem 0;">{{ evento.modificado_por.get_full_name|default:evento.modificado_por.username }}</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.5rem 0;"><strong>Última modificación:</strong></td>
                        <td style="padding: 0.5rem 0;">{{ evento.fecha_modificacion|date:"d/m/Y H:i" }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

